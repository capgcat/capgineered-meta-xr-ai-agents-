
# deploy pubsub app
gcloud components update
gcloud auth login
gcloud config set project yp-55555
gcloud config set run/region us-central1
gcloud auth configure-docker
gcloud run deploy pubsub --port 8080 --source .

gcloud run deploy pubsub \
  --port 8080 \
  --source . \
  --allow-unauthenticated \
  --set-env-vars="GOOGLE_CLOUD_PROJECT=yp-55555,GOOGLE_CLOUD_LOCATION=us-central1,GOOGLE_CLOUD_STORAGE_BUCKET=yp-55555_bkt,AGENT_ENGINE_ID=projects/yp-55555/locations/us-central1/reasoningEngines/5683164497771611008"





#pubsub creation
# Create the Pub/Sub topic
gcloud pubsub topics create iot-realtime

# Create a push subscription to the topic
# Replace <YOUR_PUSH_ENDPOINT_URL> with the actual URL, e.g., the Cloud Run URL
# For your example, it would be http://pubsub, but ensure this is a reachable endpoint
gcloud pubsub subscriptions create iot-realtime-subscription \
    --topic iot-realtime \
    --push-endpoint="http://pubsub" \
    --ack-deadline=60



#sample pubsub message:
{
  "message": {
    "data": "...", // Your actual data, base64 encoded
    "messageId": "...",
    "publishTime": "..."
    // Other optional fields like attributes
  },
  "subscription": "..." // The subscription name
}
{
  "message": {
    "data": "ewogICJkYXRhX3NvdXJjZSI6ICJhcGktc2Vuc29yLXN5c3RlbSIsCiAgImV4dHJhY3RlZF9kYXRhIjogewogICAgInNlbnNvcl9pZCI6ICJzZW5zb3JfNzgwIiwKICAgICJ0aW1lX3Nlcmllc19pZCI6ICJ0c18xMjMiLAogICAgInRpbWVzdGFampwIjogIjIwMjQtMDctMjVUMTA6MzA6MDAaIiwKICAgICJ0YXJnZXRfdmFsdWUiOiAzMC4yLAogICAgInRlbXBlcmF0dXJlX3VuaXQiOiAiQ2Vsc2l1cyIsCiAgICAiaHVtaWRpdHkiOiA1NS41LAogICAgImJhdHRlcnlfbGV2ZWwiOiA5Mi4wLAogICAgImxvY2F0aW9uIjogIkZhY3RvcnkgRmxvb3IgMjEiLAogICAgInN0YXR1cyI6ICJhY3RpdmUiLAogICAgInJlY2VpdmVkX2F0IjogIjIwMjQtMDctMjVUMTA6MzI6MTVaIiwKICAgICJtZXRhZGF0YSI6IHsKICAgICAgImFkZGl0aW9uYWxfaW5mbyI6ICJOb3JtYWwgb3BlcmF0aW5nIGNvbmRpdGlvbnMiCiAgICB9ICAgIAogIH0KfQ==",
    "messageId": "test-message-123",
    "publishTime": "2024-07-25T10:35:00Z"
  },
  "subscription": "projects/your-project-id/subscriptions/your-subscription-name"
}

{
  "data_source": "api-sensor-system",
  "extracted_data": {
    "sensor_id": "sensor_1111",
    "time_series_id": "ts_1111",
    "timestamp": "2024-07-25T10:30:00Z",
    "target_value": 30.2,
    "temperature_unit": "Celsius",
    "humidity": 55.5,
    "battery_level": 92.0,
    "location": "Factory Floor 21",
    "status": "active",
    "received_at": "2024-07-25T10:32:15Z",
    "image_url": "gs://device_readings_images/green_light.jpeg",
    "metadata": {
        "additional_info": "Normal operating conditions"
        }   
    }
}
